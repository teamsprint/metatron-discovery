<div class="pb-layout-contents">
    <!-- navi -->
    <!--
        navi 클릭시 is-selected 추가
        navi 확대시 type-open 추가
    -->

    <prep-detail-lnb [workflowType]="false"></prep-detail-lnb>

    <!-- wrap contents -->
    <div class="pb-wrap-contents">
        <div class="pb-contents-top">
            <!-- button -->
            <div class="pb-ui-buttons">
                <!-- icon button -->
                <!--<div class="pb-btn-icons">-->
                    <!--<a href="javascript:" class="pb-icon-top-undo" (click)="transformAction('UNDO')" [ngClass]="{'ddp-disabled': !undoable}"></a>-->
                    <!--<a href="javascript:" class="pb-icon-top-redo" (click)="transformAction('REDO')" [ngClass]="{'ddp-disabled': !redoable}"></a>-->
                <!--</div>-->

                <a href="javascript:;" class="pb-component-btn type-line" (click)="openSnapshotPopup()"><em class="pb-icon-add-r"></em>CREATE DATA RESULT</a>
                <!-- //icon button -->
            </div>
            <!-- //button -->
            <!-- txt navi -->
            <div class="pb-txt-navi">
                <a href="javascript:" class="pb-btn-back" (click)="onClickPrev()"></a> {{dfName}} &gt; {{dsName}}
            </div>
            <!-- //txt navi -->
        </div>
        <div class="pb-wrap-box-rule" [class.is-selected]="isNaivationOpen === true">
            <div class="pb-box-rule type-rule">
                <!-- top -->
                <div class="pb-box-top">
                    <div class="pb-fleft">
                        <span class="pb-top-label">적용항목</span>
                        <span class="pb-box-data-analysis" *ngFor="let rule of ruleList">{{rule.simplifiedRule}}</span>
                    </div>
                    <a href="javascript:" class="pb-icon-top-edit2"></a>
                </div>
                <!-- //top -->
                <div class="pb-ui-graph2">
                    <edit-rule-grid (selectHeader)="setRuleInfoFromGridHeader($event)"
                                    (contextMenuItemInfo)="onContextMenuInfo($event)" [isAggregationIncluded]="isAggregationIncluded"></edit-rule-grid>
                </div>


            </div>

        </div>
    </div>
    <!-- //wrap contents -->

    <!-- rnb -->
    <!--
        펼칠때 is-selected 추가
    -->
    <div class="pb-rnb-menu is-selected">
        <a href="javascript:" class="pb-btn-menu-close" style="display:none;"></a>
        <ul class="pb-list-rnb type-list">
            <li class="is-selected">
                <a href="javascript:">
                    <span class="pb-txt-rnb">RULE</span>
                </a>
                <ul class="pb-list-tab-button">
                    <li (click)="transformAction('UNDO')" [ngClass]="{'ddp-disabled': !undoable}">
                        <a href="javascript:"><em class="pb-icon-top-undo"></em></a>
                        <div class="pb-ui-tooltip-info">
                            <em class="pb-icon-view-top"></em>
                        </div>

                    </li>
                    <li (click)="transformAction('REDO')" [ngClass]="{'ddp-disabled': !redoable}">
                        <a href="javascript:"><em class="pb-icon-top-redo"></em></a>
                        <div class="pb-ui-tooltip-info">
                            <em class="pb-icon-view-top"></em>
                        </div>
                    </li>
                </ul>
                <!--<ul class="pb-list-rnb-tab pb-clear">-->
                    <!--<li (click)="transformAction('UNDO')" [ngClass]="{'is-selected': !undoable}">-->
                        <!--<a href="javascript:">-->
                            <!--<em class="pb-icon-tab-data"></em>-->
                        <!--</a>-->
                    <!--</li>-->
                    <!--<li (click)="transformAction('REDO')" [ngClass]="{'ddp-disabled': !redoable}">-->
                        <!--<a href="javascript:">-->
                            <!--<em class="pb-icon-tab-rule"></em>-->

                        <!--</a>-->
                    <!--</li>-->
                <!--</ul>-->
                <prep-rnb-rule-list
                        [ruleList]="ruleList"
                        (jumpEvent)="jump($event)"
                        (deleteEvent)="deleteRule($event)"
                        (editEvent)="setEditData($event)"
                        (addRuleEvent)="insertStep($event)">
                </prep-rnb-rule-list>
            </li>
            <li>
                <a href="javascript:">
                    <span class="pb-txt-rnb">RECOMMENDATION</span>
                </a>
                <prep-rnb-recommend></prep-rnb-recommend>
            </li>
        </ul>
        <!-- bottom -->
        <div class="pb-btn-bottom" style="display:none;">
            <a href="javascript:" class="pb-component-btn type-dark">
                <em class="pb-icon-dictionary"></em>Rule Dictionary
            </a>
        </div>
        <!-- //bottom -->
    </div>
    <!-- //rnb -->

    <!-- rule edit popup -->
    <div class="pb-box-ruleedit" [ngStyle]="!showRuleEdit && {'display': 'none'}" (clickOutside)="hideRuleEdit()">
        <div class="pb-ruleedit-top">
            <div class="pb-label-title">
                {{ opString === 'UPDATE' ? ('msg.dp.ui.btn.edit.rule' | translate) : ('msg.dp.ui.btn.add.rule' | translate ) }}
            </div>
            <div class="pb-ui-buttons">
                <a href="javascript:" class="pb-btn-icons-type type-close" (click)="hideRuleEdit()"></a>
            </div>
            <a href="javascript:" class="pb-component-btn" (click)="this.editorUseFlag = !this.editorUseFlag;"><em class="pb-icon-refresh"></em>
                {{ editorUseFlag ? ('msg.dp.btn.switch.builder' | translate) : ('msg.dp.btn.switch.editor' | translate ) }}
            </a>
            <!-- <div class="pb-btn-bottom">
                <a href="javascript:" class="pb-component-btn type-dark">
                    <em class="pb-icon-dictionary"></em>SAVE
                </a>
            </div> -->
        </div>

        <!-- part -->
        <div class="pb-ui-part" [ngStyle]="{'display':editorUseFlag ? 'none' : null }">
            <div class="pb-label-part">{{'msg.dp.th.command' | translate}}</div>
            <!-- box select -->
            <div class="pb-box-command">
                <!-- select box -->
                <!-- 클릭시 ddp-selected 추가 -->
                <div class="pb-form-selectbox type-value"
                     tabindex="1"
                     [ngClass]="{'ddp-selected' : isCommandListShow }"
                     (click)="$event.stopImmediatePropagation(); showCommandList()"
                     (keydown)="navigateWithKeyboardShortList($event, filteredCommandList, 'command')">
                    <input type="text" class="pb-input-selectbox" placeholder="Command" [(ngModel)]="commandSearchText" id="commandSearch">
                    <span class="pb-txt-selectbox ">{{ruleVO.command !== '' ?  ruleVO.command : 'msg.dp.ui.command.input.ph' | translate }}</span>
                    <!-- popup -->
                    <div class="pb-select-popup"
                         *ngIf="isCommandListShow"
                         (clickOutside)="isCommandListShow = false;">
                        <ul class="pb-list-selectbox pb-list-command" *ngIf="filteredCommandList.length > 0">
                            <li *ngFor="let command of filteredCommandList; let index = index;"
                                (click)="selectCommand($event, command)"
                                (mousemove)="flag === true ? flag = false : flag = true">
                                <a href="javascript:" [ngStyle]="command.isHover ? {'background-color': '#fffdf5' }:{}">
                              <span class="pb-ui-type">
                                <em class="pb-ui-round">{{command.alias}}</em>{{command.command}}
                              </span>
                                    <span class="pb-ui-code">
                                {{command.desc}}
                              </span>
                                </a>
                            </li>
                        </ul>
                        <span class="pb-txt-label2" *ngIf="filteredCommandList.length === 0">
                          {{'msg.dp.ui.search.no.rslt' | translate}}
                        </span>
                    </div>
                    <!-- //popup -->
                </div>
                <!-- //box select -->
            </div>
        </div>
        <div class="pb-block-part" [ngStyle]="{'display':editorUseFlag ? 'none' : null }"
             [ngClass]="{'type-button': existButtonCommand}">

            <!--startHeader-->
            <edit-rule-header #editRule *ngIf="'header' === ruleVO.command" ></edit-rule-header>
            <!-- //endHeader-->

            <!--startKeep-->
            <edit-rule-keep #editRule *ngIf="'keep' === ruleVO.command"
                            (advancedEditorClickEvent)="openPopupFormulaInput($event)">
            </edit-rule-keep>
            <!-- //endKeep-->

            <!-- startReplace -->
            <edit-rule-replace #editRule *ngIf="'replace' === ruleVO.command"
                               (advancedEditorClickEvent)="openPopupFormulaInput($event)">
            </edit-rule-replace>
            <!-- // endReplace -->

            <!-- startRename -->
            <edit-rule-rename #editRule *ngIf="'rename' === ruleVO.command"
                              (onEvent)="onMultiColumnRenameClick()"></edit-rule-rename>
            <!-- // endRename -->

            <!--startSet-->
            <edit-rule-set #editRule *ngIf="'set' === ruleVO.command"
                           (advancedEditorClickEvent)="openPopupFormulaInput($event)">
            </edit-rule-set>
            <!--//endSet-->

            <!--startSettype-->
            <edit-rule-settype #editRule *ngIf="'settype' === ruleVO.command"></edit-rule-settype>
            <!--//endSettype-->

            <!--startCountpattern-->
            <edit-rule-countpattern #editRule *ngIf="'countpattern' === ruleVO.command"></edit-rule-countpattern>
            <!--//endCountpattern-->

            <!--startSplit-->
            <edit-rule-split #editRule *ngIf="'split'===ruleVO.command"></edit-rule-split>
            <!--//endSplit-->

            <!--startDerive-->
            <edit-rule-derive #editRule *ngIf="'derive' === ruleVO.command"
                              (advancedEditorClickEvent)="openPopupFormulaInput($event)">
            </edit-rule-derive>
            <!--//endDerive-->

            <!--startDelete-->
            <edit-rule-delete #editRule *ngIf="'delete' === ruleVO.command"
                              (advancedEditorClickEvent)="openPopupFormulaInput($event)">
            </edit-rule-delete>
            <!--//endDelete-->

            <!--startDrop-->
            <edit-rule-drop #editRule *ngIf="'drop' === ruleVO.command" ></edit-rule-drop>
            <!--//endDrop-->

            <!--startExtract-->
            <edit-rule-extract #editRule *ngIf="'extract'===ruleVO.command"></edit-rule-extract>
            <!--//endExtract-->

            <!--startFlatten-->
            <edit-rule-flatten #editRule *ngIf="'flatten' === ruleVO.command"></edit-rule-flatten>
            <!--//endFlatten-->

            <!--startMerge-->
            <edit-rule-merge #editRule *ngIf="'merge' === ruleVO.command"></edit-rule-merge>
            <!--//endMerge-->

            <!--startAggregate-->
            <edit-rule-aggregate #editRule *ngIf="'aggregate' === ruleVO.command"></edit-rule-aggregate>
            <!--//endAggregate-->

            <!--startSort-->
            <edit-rule-sort #editRule *ngIf="'sort' === ruleVO.command"></edit-rule-sort>
            <!--//endSort-->

            <!--startMove-->
            <edit-rule-move #editRule *ngIf="'move' === ruleVO.command"></edit-rule-move>
            <!--//endMove-->

            <!--start pivot -->
            <edit-rule-pivot #editRule *ngIf="'pivot' === ruleVO.command"></edit-rule-pivot>
            <!-- end pivot -->

            <!--start unpivot -->
            <edit-rule-unpivot #editRule *ngIf="'unpivot' === ruleVO.command"></edit-rule-unpivot>
            <!--//endUnpivot-->

            <!--startNest-->
            <edit-rule-nest #editRule *ngIf="'nest' === ruleVO.command"></edit-rule-nest>
            <!--//endNest-->

            <!--startUnnest-->
            <edit-rule-unnest #editRule *ngIf="'unnest' === ruleVO.command"
                              [firstRow]="selectedDataSet.gridData.data?selectedDataSet.gridData.data[0]:null">
            </edit-rule-unnest>
            <!--//endUnnest-->

            <!--startSetformat-->
            <edit-rule-setformat #editRule *ngIf="'setformat' === ruleVO.command"></edit-rule-setformat>
            <!--endSetformat-->

            <!--startSetformat-->
            <edit-rule-window #editRule *ngIf="'window' === ruleVO.command"></edit-rule-window>
            <!--endSetformat-->
        </div>

        <div class="pb-block-part" *ngIf="editorUseFlag">
            <!-- editor 모드 -->
            <div class="pb-part-content">
                <div class="pb-form-create">
                    <div class="pb-create-label">{{'msg.dp.th.command' | translate}}</div>
                    <div class="pb-form-edit">
                        <textarea class="pb-component-textarea-auto" style="height: 300px;"
                                  placeholder="{{'msg.dp.alert.command.input.ph' | translate}}"
                                  [(ngModel)]="inputRuleCmd"></textarea>
                    </div>
                </div>
            </div>
        </div>
        <!-- //part -->
        <div class="pb-ruleedit-bottom">
            <a href="javascript:" class="pb-component-btn type-dark" (click)="addRule()">
                {{ opString !== 'UPDATE' ? ('msg.dp.btn.add' | translate) : ('msg.comm.btn.done2' | translate ) }}
            </a>
        </div>
    </div>
    <!-- //rule edit popup -->

</div>

<!-- Join rule popup -->
<app-rule-join-popup *ngIf="isRuleJoinModalShow"
                     [existingDataSet]="selectedDataSet"
                     [serverSyncIndex]="serverSyncIndex"
                     [dfId]="dfId"
                     [rightDataset]="rightDataset"
                     [editRuleStr]="editJoinOrUnionRuleStr"
                     (joinComplete)="ruleJoinComplete($event);">
</app-rule-join-popup>
<!-- // Join rule popup -->

<!-- Union rule popup -->
<app-rule-union-popup [masterDataset]="selectedDataSet"
                      [serverSyncIndex]="serverSyncIndex"
                      [dfId]="dfId"
                      [editRuleStr]="editJoinOrUnionRuleStr"
                      (unionComplete)="ruleUnionComplete($event);"
                      *ngIf="isRuleUnionModalShow">
</app-rule-union-popup>
<!-- // Union rule popup -->

<multiple-rename-popup (renameMultiColumns)="onRenameMultiColumns($event);"></multiple-rename-popup>

<!-- Advanced editor popup -->
<app-extend-input-formula (done)="doneInputFormula($event)"></app-extend-input-formula>
<!-- // Advanced editor popup -->

<prep-pop-result-create [hidden]="isCreateDataresultPopupOpen == false"
                        (snapshotCloseEvent)="closeSnapshotPopup()"
                        (snapshotCreateFinishEvent)="snapshotCreateFinish($event)"></prep-pop-result-create>